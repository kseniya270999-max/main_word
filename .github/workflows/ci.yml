name: CI/CD

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  build_test_package:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential dpkg-dev

      - name: Build program
        run: |
          gcc -O2 -Wall -Wextra -o main_word src/main-word.c
          mkdir -p usr/bin
          cp main_word usr/bin/main_word

      - name: Run tests
        run: |
          set -e
          BIN="./usr/bin/main_word"

          test_case () {
            name="$1"
            input="$2"
            expected="$3"
            output="$(printf "%s\n" "$input" | "$BIN")"
            echo "$output" | grep -q "$expected"
            echo "PASS: $name"
          }

          test_case "empty string" "" "Number of words in string = 0"
          test_case "one word" "hello" "Number of words in string = 1"
          test_case "two words" "hello world" "Number of words in string = 2"
          test_case "spaces" "  hello   world  " "Number of words in string = 2"
          test_case "tabs" $'hello\tworld test' "Number of words in string = 3"

      - name: Build deb package
        run: |
          NAME="main-word"
          VERSION="0.1.${GITHUB_RUN_NUMBER}"
          ARCH="amd64"

          rm -rf package dist
          mkdir -p package/DEBIAN package/usr/bin dist
          cp usr/bin/main_word package/usr/bin/

          SIZE=$(du -sk package/usr | awk '{print $1}')

          cat > package/DEBIAN/control <<EOF
          Package: $NAME
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: $ARCH
          Depends: libc6
          Installed-Size: $SIZE
          Maintainer: Student
          Description: Program that counts number of words in a string
          EOF

          dpkg-deb --build package dist/${NAME}_${VERSION}_${ARCH}.deb

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: dist/*.deb
